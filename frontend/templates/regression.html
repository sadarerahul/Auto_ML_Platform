{% extends "base.html" %}
{% block title %}Regression Workflow - RPDS{% endblock %}

{% block content %}
<div class="row">

  <!-- ▓▓▓ SIDEBAR -->
  <div class="col-md-3 mb-4">
    <div class="list-group custom-sticky-sidebar shadow-sm rounded-3">

      <!-- 📂 Dataset Switcher (Only on Upload Page) -->
      {% if page == "upload" %}
      <form action="/regression/switch_dataset" method="post" class="mb-3">
        <div class="d-flex align-items-center bg-dark border border-info rounded px-3 py-2 shadow-sm">
          <i class="fas fa-database text-warning me-2"></i>
          <label for="selected_dataset" class="form-label text-info fw-semibold me-2 mb-0">Active:</label>
          <select name="selected_dataset"
                  class="form-select form-select-sm w-auto bg-dark text-light border-info"
                  onchange="this.form.submit()">
            <option disabled {% if not active_file %}selected{% endif %}>-- Select --</option>
            {% for file in files %}
              <option value="{{ file }}" {% if file == active_file %}selected{% endif %}>{{ file }}</option>
            {% endfor %}
          </select>
        </div>
      </form>
      {% else %}
      <div class="card bg-dark text-light border border-info mb-4 shadow-sm">
        <div class="card-body d-flex align-items-center py-2 px-3">
          <i class="fas fa-database me-3 text-warning fs-5"></i>
          <div>
            <div class="small text-muted">Active Dataset</div>
            <div class="fw-semibold text-info">{{ active_file }}</div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- 📌 MAIN WORKFLOW STAGES -->

      <div class="mb-1">
        <a href="/regression/upload" class="list-group-item list-group-item-action {% if page == 'upload' %}active{% endif %}">
          <i class="fas fa-upload me-2"></i> 1️⃣ Upload Data
        </a>

        <a href="/regression/eda" class="list-group-item list-group-item-action {% if page == 'eda' %}active{% endif %}">
          <i class="fas fa-chart-bar me-2"></i> 2️⃣ EDA Dashboard
        </a>
      </div>

      <!-- 🛠️ Preprocessing Section -->
      <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if page in ['clean','visualize','outliers','scale','select_features','pca','smooth','split'] %}active{% endif %}"
              data-bs-toggle="collapse"
              data-bs-target="#preprocessCollapse"
              aria-expanded="{% if page in ['clean','visualize','outliers','categories','scale','select_features','pca','smooth','split'] %}true{% else %}false{% endif %}">
        <span><i class="fas fa-cogs me-2"></i> 3️⃣ Preprocessing</span>
        <i class="fas fa-chevron-down small"></i>
      </button>

      <div id="preprocessCollapse" class="collapse {% if page in ['clean','visualize','categories','outliers','scale','select_features','pca','smooth','split'] %}show{% endif %}">
        <a href="/regression/clean" class="list-group-item list-group-item-action ps-5 {% if page == 'clean' %}active{% endif %}">
          🧹 Clean & Encode
        </a>
        <a href="/regression/visualize" class="list-group-item list-group-item-action ps-5 {% if page == 'visualize' %}active{% endif %}">
          📊 Visualize Data
        </a>
        <a href="/regression/categories" class="list-group-item list-group-item-action ps-5 {% if page == 'categories' %}active{% endif %}">
          📊 categories Visualisation
        </a>
        <a href="/regression/outliers" class="list-group-item list-group-item-action ps-5 {% if page == 'outliers' %}active{% endif %}">
          🚨 Outlier Handling
        </a>
        <a href="/regression/smooth" class="list-group-item list-group-item-action ps-5 {% if page == 'smooth' %}active{% endif %}">
          🧮 Smoothing
        </a>
        <a href="/regression/select_features" class="list-group-item list-group-item-action ps-5 {% if page == 'select_features' %}active{% endif %}">
          🧠 Feature Selection
        </a>
        <a href="/regression/split" class="list-group-item list-group-item-action ps-5 {% if page == 'split' %}active{% endif %}">
          🔀 Train-Test Split
        </a>
        <a href="/regression/scale" class="list-group-item list-group-item-action ps-5 {% if page == 'scale' %}active{% endif %}">
          📏 Scaling
        </a>  
      </div>

      <!-- ⚙️ Modeling & Prediction -->
      <div class="mt-1">
        <a href="/regression/model" class="list-group-item list-group-item-action {% if page == 'model' %}active{% endif %}">
          <i class="fas fa-brain me-2"></i> 4️⃣ Model Selection
        </a>

        <a href="/regression/tune" class="list-group-item list-group-item-action {% if page == 'tune' %}active{% endif %}">
          <i class="fas fa-sliders-h me-2"></i> 5️⃣ Hyperparameter Tuning
        </a>

        <a href="/regression/predict" class="list-group-item list-group-item-action {% if page == 'predict' %}active{% endif %}">
          <i class="fas fa-magic me-2"></i> 6️⃣ Predict
        </a>
      </div>

      <!-- 🗑️ Dataset Delete -->
      {% if page == "upload" and files %}
      <hr class="border-secondary">
      <h6 class="text-light mb-2">Stored Datasets ({{ files|length }}/{{ max_datasets }})</h6>

      {% if show_delete %}
      <div class="alert alert-warning small">⚠️ Max limit reached. Delete to upload more.</div>
      {% endif %}

      <form action="/regression/delete" method="post">
        <div class="list-group list-group-flush mb-3">
          {% for f in files %}
          <label class="list-group-item bg-dark text-light border border-secondary d-flex justify-content-between align-items-center px-3 py-2 mb-2 rounded">
            <div class="form-check">
              <input class="form-check-input me-2" type="checkbox" name="filenames" value="{{ f }}" id="f{{ loop.index }}">
              <span class="{% if f == active_file %}fw-bold text-warning{% endif %}">
                <i class="fas fa-file-alt me-1 text-info"></i> {{ f }}
              </span>
            </div>
          </label>
          {% endfor %}
        </div>
        <button class="btn btn-outline-danger w-100" type="submit">🗑️ Delete Selected</button>
      </form>
      {% endif %}
    </div>
  </div>

  <!-- ▓▓▓ MAIN PANEL -->
  <div class="col-md-9">
    <div class="card bg-dark text-light border-secondary shadow-lg">
      <div class="card-body">
        <h4 class="card-title text-info mb-3">
          <i class="fas fa-project-diagram me-2"></i>Regression Workflow
        </h4>
        <p class="text-muted mb-4">
          This pipeline guides you from raw data to insights and predictions — no coding required.
        </p>

        <!-- 📊 Step Progress Bar -->
        {% set preprocessing_pages = ['clean', 'visualize','categories', 'outliers', 'scale', 'split', 'select_features', 'smooth'] %}
        {% set total_steps = 6 %}
        {% set step_names = {
          "upload": 1, "eda": 2, "clean": 3, "visualize": 3, "outliers": 3,'categories':3, "scale": 3, "split": 3, "select_features": 3, "smooth": 3,
          "model": 4, "tune": 5, "predict": 6
        } %}
        {% set current_step = step_names.get(page, 1) %}
        {% set progress_percent = (current_step / total_steps * 100) | round(0, 'ceil') %}

        <div class="progress mb-4" style="height:18px;">
          <div class="progress-bar bg-info" style="width:{{ progress_percent }}%;">
            Step {{ current_step }} / {{ total_steps }}
          </div>
        </div>

        <!-- 🔄 Dynamic Workflow Panel -->
        <div id="regression-content">
          {% block regression_content %}
          <p class="text-muted">Select a step from the sidebar to begin.</p>
          {% endblock %}
        </div>

      </div>
    </div>
  </div>

</div>
{% endblock %}

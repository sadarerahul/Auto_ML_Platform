{% extends "base.html" %}

{% block title %}Regression Workflow - RPDS{% endblock %}

{% block content %}
<div class="row">
  <!-- ▓▓▓ SIDEBAR ▓▓▓ -->
  <div class="col-md-3 mb-4">
    <div class="list-group custom-sticky-sidebar shadow-sm rounded-3">

      <!-- 1️⃣ Upload Data -->
      <a href="/regression/upload"
         class="list-group-item list-group-item-action {% if page == 'upload' %}active{% endif %}">
        <i class="fas fa-upload me-2"></i>1️⃣ Upload Data
      </a>

      <!-- 2️⃣ Pre‑processing section -->
      <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if page in ['clean','visualize','outliers','scale','select_features','pca'] %}active{% endif %}"
              data-bs-toggle="collapse"
              data-bs-target="#preprocessCollapse"
              aria-expanded="{% if page in ['clean','visualize','outliers','scale','select_features','pca'] %}true{% else %}false{% endif %}">
        <span><i class="fas fa-cogs me-2"></i>2️⃣ Preprocessing</span>
        <i class="fas fa-chevron-down small"></i>
      </button>

      <div id="preprocessCollapse"
           class="collapse {% if page in ['clean','visualize','outliers','scale','select_features','pca'] %}show{% endif %}">
        <a href="/regression/clean"
           class="list-group-item list-group-item-action ps-5 {% if page == 'clean' %}active{% endif %}">
          🧹 Clean & Encode
        </a>
        <a href="/regression/visualize"
           class="list-group-item list-group-item-action ps-5 {% if page == 'visualize' %}active{% endif %}">
          📊 Visualize Data
        </a>
        <a href="/regression/outliers"
           class="list-group-item list-group-item-action ps-5 {% if page == 'outliers' %}active{% endif %}">
          🚨 Outlier Handling
        </a>
        <a href="/regression/scale"
           class="list-group-item list-group-item-action ps-5 {% if page == 'scale' %}active{% endif %}">
          📏 Scaling
        </a>
        <a href="/regression/select_features"
           class="list-group-item list-group-item-action ps-5 {% if page == 'select_features' %}active{% endif %}">
          🧠 Feature Selection
        </a>
        <a href="/regression/pca"
           class="list-group-item list-group-item-action ps-5 {% if page == 'pca' %}active{% endif %}">
          🧮 PCA (Optional)
        </a>
      </div>

      <!-- 3️⃣‑6️⃣ Other steps -->
      <a href="/regression/split"
         class="list-group-item list-group-item-action {% if page == 'split' %}active{% endif %}">
        <i class="fas fa-random me-2"></i>3️⃣ Train‑Test Split
      </a>
      <a href="/regression/model"
         class="list-group-item list-group-item-action {% if page == 'model' %}active{% endif %}">
        <i class="fas fa-cogs me-2"></i>4️⃣ Model Selection
      </a>
      <a href="/regression/train"
         class="list-group-item list-group-item-action {% if page == 'train' %}active{% endif %}">
        <i class="fas fa-play-circle me-2"></i>5️⃣ Train & Evaluate
      </a>
      <a href="/regression/predict"
         class="list-group-item list-group-item-action {% if page == 'predict' %}active{% endif %}">
        <i class="fas fa-magic me-2"></i>6️⃣ Predict New Data
      </a>
    </div>

    {# ▓▓▓ DATASET LIST ▓▓▓ #}
    {% if files %}
      <hr class="border-secondary">
      <h5 class="text-light">
        📂 Stored Datasets ({{ files|length }}/{{ max_datasets }})
      </h5>

      {% if show_delete %}
        <div class="alert alert-warning">
          Maximum of {{ max_datasets }} datasets reached. Delete at least one to upload another.
        </div>
      {% endif %}

      <form action="/regression/delete" method="post" class="mb-3">
        {% for f in files %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox"
                   name="filenames" value="{{ f }}" id="f{{ loop.index }}">
            <label class="form-check-label text-light
                   {% if f == active_file %}fw-bold text-warning{% endif %}"
                   for="f{{ loop.index }}">
              {{ f }}
            </label>
          </div>
        {% endfor %}
        <button class="btn btn-outline-danger mt-2" type="submit">
          🗑️ Delete Selected
        </button>
      </form>
    {% endif %}
  </div> <!-- /sidebar -->

  <!-- ▓▓▓ MAIN PANEL ▓▓▓ -->
  <div class="col-md-9">
    <div class="card bg-dark text-light border-secondary shadow-lg">
      <div class="card-body">
        <h4 class="card-title text-info mb-3">
          <i class="fas fa-project-diagram me-2"></i>Regression Workflow
        </h4>
        <p class="text-muted mb-4">
          This workflow guides you through a complete regression pipeline — from data upload to prediction and visualization.
        </p>

        <!-- Progress bar -->
        {% set total_steps = 7 %}
        {% set step_names = {
          "upload": 1, "clean": 2, "visualize": 3, "model": 4,
          "train": 5, "predict": 6, "results": 7
        } %}
        {% set current_step = step_names.get(page, 1) %}
        {% set progress_percent = (current_step / total_steps * 100) | round(0, 'ceil') %}
        <div class="progress mb-4" style="height:18px;">
          <div class="progress-bar bg-info" style="width:{{ progress_percent }}%;">
            Step {{ current_step }} / {{ total_steps }}
          </div>
        </div>

        <!-- Dynamic content -->
        <div id="regression-content">
          {% block regression_content %}
            <p class="text-muted">Select a step from the sidebar to begin.</p>
          {% endblock %}
        </div>
      </div>
    </div>
  </div> <!-- /main -->
</div>
{% endblock %}

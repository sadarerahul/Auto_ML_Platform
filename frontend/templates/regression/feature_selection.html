{% extends "regression.html" %}

{% block regression_content %}
<div class="card bg-dark border-secondary shadow-sm mb-4">
  <div class="card-body">
    <h4 class="card-title text-info mb-2">ğŸ” Feature Selection</h4>
    <p class="text-muted">Identify and score the most informative features based on correlation with your target.</p>

    <!-- Correlation Form -->
    <form method="post" class="row g-3 mb-4">
      <div class="col-md-6">
        <label class="form-label">ğŸ¯ Target Variable (y)</label>
        <select name="target_col" class="form-select" required>
          {% for col in numeric_columns %}
            <option value="{{ col }}" {% if col == target_col %}selected{% endif %}>{{ col }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">Topâ€‘K Features</label>
        <input type="number" name="top_k" class="form-control" min="1" value="{{ top_k or 10 }}" required>
      </div>

      <div class="col-md-3 d-grid align-items-end">
        <button type="submit" class="btn btn-outline-success">ğŸ“ˆ Correlate</button>
      </div>
    </form>

    {% if message %}
      <div class="alert alert-info">{{ message }}</div>
    {% endif %}

    {% if plot_html %}
      <hr class="border-secondary mb-3">
      <h5 class="text-light">ğŸ“Š Correlation Chart</h5>
      <div class="bg-white border rounded-3 p-2 mb-3">
        {{ plot_html | safe }}
      </div>
    {% endif %}
  </div>
</div>

<div class="card bg-dark border-secondary shadow-sm">
  <div class="card-body">
    <h4 class="card-title text-info mb-3">ğŸ—‚ï¸ Define X and y for Modeling</h4>

    <form action="/regression/select_features/xy" method="post">
      <div class="row g-3">
        <!-- y Column -->
        <div class="col-md-6">
          <label class="form-label text-light">ğŸ¯ Choose Target Column (y)</label>
          <div class="border rounded p-2">
            {% for col in numeric_columns %}
              <div class="form-check">
                <input class="form-check-input" type="radio" name="y_col"
                       id="y{{ loop.index }}" value="{{ col }}"
                       {% if xy_state.y == col or target_col == col %}checked{% endif %}>
                <label class="form-check-label text-light" for="y{{ loop.index }}">{{ col }}</label>
              </div>
            {% endfor %}
          </div>
        </div>

        <!-- X Columns -->
        <div class="col-md-6">
          <label class="form-label text-light">ğŸ“Š Choose Predictor Columns (X)</label>
          <div class="border rounded p-2" id="x-columns-box">
            {% for col in numeric_columns %}
              {% if col != target_col %}
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="x_cols"
                         id="x{{ loop.index }}" value="{{ col }}"
                         {% if col in xy_state.X or col in selected_features %}checked{% endif %}>
                  <label class="form-check-label text-light" for="x{{ loop.index }}">{{ col }}</label>
                </div>
              {% endif %}
            {% endfor %}
          </div>
          <div class="mt-2">
            <button type="button" class="btn btn-sm btn-outline-warning" onclick="selectAllExceptTarget()">Select All Except Target</button>
          </div>
        </div>
      </div>

      <div class="mt-4 text-end">
        <button type="submit" class="btn btn-outline-primary">ğŸ’¾ Save X / y</button>
      </div>
    </form>

    {% if xy_state.y %}
      <div class="alert alert-success mt-4">
        âœ… Current selection saved:<br>
        <strong>y = {{ xy_state.y }}</strong><br>
        X = {{ xy_state.X | join(", ") }}
      </div>
    {% endif %}
  </div>
</div>

<script>
function selectAllExceptTarget() {
  const target = document.querySelector('input[name="y_col"]:checked')?.value;
  document.querySelectorAll('input[name="x_cols"]').forEach(cb => {
    cb.checked = (cb.value !== target);
  });
}
</script>
{% endblock %}

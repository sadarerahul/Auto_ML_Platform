{% extends "regression.html" %}

{% block regression_content %}
<div class="container mt-4">

    <h2 class="mb-4 text-primary">📊 Exploratory Data Analysis Dashboard</h2>

    {% if error %}
    <div class="alert alert-warning shadow-sm">
        <i class="bi bi-exclamation-triangle-fill me-2"></i><strong>Warning:</strong> {{ error }}
    </div>
    {% endif %}

    {% if overview %}
    <div class="card mb-4 shadow-sm border-info">
        <div class="card-header bg-info text-white fw-bold">🧾 Dataset Overview</div>
        <div class="card-body">
            <p><strong>Shape:</strong> {{ overview.shape }}</p>
            <p><strong>Rows:</strong> {{ overview.n_rows }}, <strong>Columns:</strong> {{ overview.n_cols }}</p>
            <ul class="list-group list-group-flush">
                {% for col in overview.columns %}
                <li class="list-group-item">{{ col.Column }} <code class="text-muted">({{ col.Dtype }})</code></li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    <!-- Describe Button -->
    <form method="post" action="/regression/eda">
        <button type="submit" class="btn btn-outline-primary mb-4">
            🔍 Run Descriptive Statistics
        </button>
    </form>

    {% if describe %}
    <div class="accordion mb-5" id="describeAccordion">

        <div class="accordion-item border-success">
            <h2 class="accordion-header">
                <button class="accordion-button" data-bs-toggle="collapse" data-bs-target="#collapseSummary">
                    📈 Summary Statistics
                </button>
            </h2>
            <div id="collapseSummary" class="accordion-collapse collapse show">
                <div class="accordion-body">
                    {{ describe.summary | safe }}
                </div>
            </div>
        </div>

        <div class="accordion-item border-warning">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#collapseMissing">
                    ❓ Missing Values Info
                </button>
            </h2>
            <div id="collapseMissing" class="accordion-collapse collapse">
                <div class="accordion-body">
                    {{ describe.missing | safe }}
                </div>
            </div>
        </div>

    </div>
    {% endif %}

    {% if univariate %}
    <h4 class="mt-5">🔹 Univariate Plots</h4>
    <div class="row g-4">
        {% for plot in univariate %}
        <div class="col-12 col-md-6">
            <div class="card shadow-sm">
                <iframe src="{{ plot }}" height="400" width="100%" frameborder="0" class="rounded-bottom"></iframe>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if multivariate %}
    <h4 class="mt-5">🔸 Multivariate Plots</h4>
    <div class="row g-4">
        {% for plot in multivariate %}
        <div class="col-12 col-md-6">
            <div class="card shadow-sm">
                {% if plot.endswith('.html') %}
                <iframe src="{{ plot }}" height="400" width="100%" frameborder="0" class="rounded-bottom"></iframe>
                {% else %}
                <img src="{{ plot }}" class="img-fluid rounded-bottom" alt="Multivariate Plot" />
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if columns %}
    <div class="card mt-5 shadow-sm border-success">
        <div class="card-header bg-success text-white fw-bold">
            🎯 Target-Based Filtering
        </div>
        <div class="card-body">
            <form method="post" action="/regression/eda/filter">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="target_column" class="form-label">Target Column</label>
                        <select class="form-select" name="target_column" required>
                            {% for col in columns %}
                            <option value="{{ col }}">{{ col }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Lower Percentile (%)</label>
                        <input type="number" name="lower_percentile" class="form-control" min="0" max="100" step="any" value="25" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Upper Percentile (%)</label>
                        <input type="number" name="upper_percentile" class="form-control" min="0" max="100" step="any" value="75" required>
                    </div>
                    <div class="col-md-2 d-grid align-items-end">
                        <button type="submit" class="btn btn-outline-success mt-2">
                            ➕ Apply Filter
                        </button>
                    </div>
                </div>
            </form>

            {% if filtered_file %}
            <div class="mt-3">
                <p class="text-muted small mb-1">Filtered dataset saved as:</p>
                <a href="/static/cleaned/{{ filtered_file }}" class="btn btn-sm btn-outline-primary" download>
                    ⬇️ Download Filtered Dataset
                </a>
            </div>
            {% endif %}

            {% if filter_shape %}
            <div class="alert alert-info mt-3 shadow-sm">
                <strong>Filtered Dataset Shape:</strong> {{ filter_shape }}
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}
